<html>
 <head>
  <meta charset="utf-8"/>
 </head>
 <body>
  <table border="1">
   <tr>
    <td>
     <b>
      Time limit:
     </b>
    </td>
    <td>
     <tt>
      1 s
     </tt>
    </td>
   </tr>
   <tr>
    <td>
     <b>
      Real time limit:
     </b>
    </td>
    <td>
     <tt>
      5 s
     </tt>
    </td>
   </tr>
   <tr>
    <td>
     <b>
      Memory limit:
     </b>
    </td>
    <td>
     <tt>
      64M
     </tt>
    </td>
   </tr>
  </table>
  <h3>
   Problem sm10-4: unix/files/writechar-2
  </h3>
  <p>
   Опишите структуру
   <tt>
    FileWriteState
   </tt>
   для хранения состояния буферизованного вывода в файл. Структура
может быть описана примерно так:
  </p>
  <pre>struct FileWriteState
{
    int fd;              // "файловый дескриптор", для вывода на стандартный поток вывода - 1
    unsigned char *buf;  // указатель на буфер
    int bufsize;         // размер буфера
    // здесь потребуется добавить поля для реализации буферизованной записи
};</pre>
  <p>
   Определите глобальную переменную:
  </p>
  <pre>struct FileWriteState *stout;</pre>
  <p>
   В вашей реализации переменная
   <tt>
    stout
   </tt>
   должна быть уже инициализирована корректным указателем
на корректную структуру состояния записи при запуске программы (то есть используйте инициализацию
глобальных переменных). Буфер должен быть выделен статически, его размер должен быть равен 4KiB.
  </p>
  <p>
   Напишите подпрограммы
   <tt>
    writechar
   </tt>
   и
   <tt>
    flush
   </tt>
   для буферизированного посимвольного вывода.
  </p>
  <pre>void writechar(int c, struct FileWriteState *out);
void flush(struct FileWriteState *out);</pre>
  <p>
   Функция
   <tt>
    writechar
   </tt>
   принимает в регистре %ecx байт для вывода,
а в регистре %edx — указатель на структуру состояния вывода.
Этот байт не отправляется на поток вывода с помощью системного вызова write немедленно,
а накапливается в буфере вывода. Когда буфер вывода заполняется, вызывается подпрограмма
   <tt>
    flush
   </tt>
   для записи содержимого буфера на устройство.
  </p>
  <p>
   Функция
   <tt>
    flush
   </tt>
   принимает в регистре %ecx указатель на структуру состояния вывода.
Функция использует системный вызов
   <tt>
    write
   </tt>
   для записи содержимого буфера
за один раз. Будем предполагать, что операция записи завершается успешно и полностью
записывает буфер. Размер буфера - 4KiB.
  </p>
  <p>
   Обратите внимание, что программа, использующая
   <tt>
    writechar
   </tt>
   , должна не забыть вызвать
   <tt>
    flush
   </tt>
   перед завершением, так как в противном случае будет потеряна часть данных, еще находящаяся в выходном буфере.
  </p>
  <p>
   Функции должны быть написаны на Си, но при этом вам не будет доступна стандартная библиотека Си, включая функцию
   <tt>
    write
   </tt>
   (программа будет компилироваться с флагом -nostdlib). Для выполнения системного вызова записи используйте встроенный в gcc ассемблер
(ключевое слово asm). Обратите внимание, что для функции
   <tt>
    writechar
   </tt>
   используется необычное соглашение о вызовах функции.
Используйте конструкцию __attribute__ для управления соглашениями о вызове.
  </p>
 </body>
</html>